<!doctype html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hallowed Hand Bingo</title>

    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @media print {
            .print\:hidden {
                display: none !important
            }

            .print\:avoid-break {
                break-inside: avoid
            }

            body {
                background: white
            }
        }
    </style>
</head>

<body class="min-h-screen bg-slate-50 dark:bg-slate-900 dark:text-slate-100 text-slate-900">
    <noscript>
        <div class="max-w-2xl mx-auto p-6">This page requires JavaScript.</div>
    </noscript>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <script type="text/babel">
        const { useMemo, useState, useEffect } = React;

        // ======= Data =======
        const ENTRIES = [
            "Forgets their turn", "This might be a trap", "Nat 20 save", "Checks coin / magic item", "Melee complains about ranged",
            "Potion used in combat", "Argues about routes", "Crit hit changes fight", "Complains about cold", "DM describes snow",
            "Zach summons echo again", "Heather Rolls Nat 1", "Mispronounces NPC name", "Mike has to heal", "Forgets Inspiration",
            "Don’t like this guy…", "Sorcerer burns a big slot", "Fighter shouts ‘I charge!’", "Stealth plan fails", "Shanice checks tracks",
            "Nat 1 fail", "Finds something unexpected", "Timer runs out", "Discovers a mysterious clue", "Tries to talk their way out of trouble", "Tries to bribe their way out of trouble",
        ];

        // ======= RNG / Board helpers =======
        function mulberry32(seed) {
            let a = seed >>> 0;
            return function () {
                a |= 0; a = (a + 0x6D2B79F5) | 0;
                let t = Math.imul(a ^ a >>> 15, 1 | a);
                t = (t + Math.imul(t ^ t >>> 7, 61 | t)) ^ t;
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            };
        }
        function shuffle(arr, rng) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(rng() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        function buildBoard(rng) {
            const pool = shuffle(ENTRIES, rng).slice(0, 24);
            return [...pool.slice(0, 12), "FREE", ...pool.slice(12)];
        }

        // ======= Bingo lines =======
        const LINES = (() => {
            const lines = [];
            for (let r = 0; r < 5; r++) lines.push([0, 1, 2, 3, 4].map(c => r * 5 + c));
            for (let c = 0; c < 5; c++) lines.push([0, 1, 2, 3, 4].map(r => r * 5 + c));
            lines.push([0, 6, 12, 18, 24]); lines.push([4, 8, 12, 16, 20]);
            return lines;
        })();
        function hasBingo(marked) { return LINES.some(line => line.every(i => marked[i])); }
        function indicesInBingo(marked) {
            const set = new Set();
            LINES.forEach(line => { if (line.every(i => marked[i])) line.forEach(i => set.add(i)); });
            return set;
        }

        // ======= Same-device persistence: seed in URL + localStorage =======
        function getInitialSeed() {
            const url = new URL(window.location.href);
            const fromUrl = url.searchParams.get("seed");
            if (fromUrl && !Number.isNaN(parseInt(fromUrl, 10))) return parseInt(fromUrl, 10);

            const fromLS = localStorage.getItem("hh-seed");
            if (fromLS && !Number.isNaN(parseInt(fromLS, 10))) return parseInt(fromLS, 10);

            return Math.floor(Math.random() * 2 ** 31);
        }

        // ======= Components =======
        function BingoGrid({ cells, boardKey }) {
            const stored = localStorage.getItem(boardKey);
            const initial = stored ? JSON.parse(stored) : Array(25).fill(false);
            if (!stored) initial[12] = true; // center FREE

            const [marked, setMarked] = useState(initial);
            const [didBingo, setDidBingo] = useState(false);

            useEffect(() => { localStorage.setItem(boardKey, JSON.stringify(marked)); }, [boardKey, marked]);

            const bingo = hasBingo(marked);
            const highlighted = indicesInBingo(marked);

            // Fire confetti once per bingo
            useEffect(() => {
                if (bingo && !didBingo) {
                    setDidBingo(true);
                    confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
                }
            }, [bingo, didBingo]);

            function toggle(i) { setMarked(m => { const copy = m.slice(); copy[i] = !copy[i]; return copy; }); }
            function clearAll() { setMarked(Array(25).fill(false).map((_, i) => i === 12)); setDidBingo(false); }

            return (
                <div>
                    <div className="grid grid-cols-5 gap-1 sm:gap-2 select-none w-full">
                        {Array.from({ length: 25 }).map((_, i) => {
                            const isMarked = marked[i];
                            const isFree = i === 12;
                            const inBingo = highlighted.has(i);
                            return (
                                <button
                                    key={i}
                                    type="button"
                                    onClick={() => toggle(i)}
                                    className={
                                        "aspect-square flex-1 rounded-2xl border p-1 sm:p-2 " +
                                        "flex items-center justify-center text-center " +
                                        "text-[11px] sm:text-xs md:text-sm leading-snug whitespace-pre-line " +
                                        "transition select-none " +
                                        (inBingo
                                            ? "bg-green-300 dark:bg-emerald-700/60 border-green-500 "
                                            : isMarked
                                                ? "bg-blue-200 dark:bg-blue-800/60 border-blue-400 "
                                                : "bg-white dark:bg-slate-900/60 border-slate-300 dark:border-slate-700 "
                                        ) +
                                        (isFree ? "font-semibold " : "") +
                                        "hover:shadow-sm active:scale-[0.99]"
                                    }
                                >
                                    <span>{cells[i]}</span>
                                </button>
                            );
                        })}
                    </div>
                    <div className="flex gap-2 mt-3">
                        <button onClick={clearAll} className="px-3 py-2 rounded-2xl bg-white dark:bg-slate-800 border shadow">Clear</button>
                        {hasBingo(marked) && <span className="px-3 py-2 rounded-2xl bg-emerald-600 text-white">BINGO!</span>}
                    </div>
                </div>
            );
        }

        function App() {
            const [seed, setSeed] = useState(getInitialSeed);
            const [count, setCount] = useState(1);
            const [dark, setDark] = useState(
                () => localStorage.getItem("hh-dark") === "1" ||
                    document.documentElement.classList.contains("dark")
            );

            // keep URL + LS in sync with the current seed
            useEffect(() => {
                const url = new URL(window.location.href);
                url.searchParams.set("seed", String(seed));
                history.replaceState(null, "", url.toString());
                localStorage.setItem("hh-seed", String(seed));
            }, [seed]);

            // persist dark mode
            useEffect(() => {
                document.documentElement.classList.toggle("dark", dark);
                localStorage.setItem("hh-dark", dark ? "1" : "0");
            }, [dark]);

            const boards = useMemo(() => {
                const rng = mulberry32(seed);
                return Array.from({ length: count }, (_, idx) => ({ idx, cells: buildBoard(rng) }));
            }, [seed, count]);

            function randomize() { setSeed(Math.floor(Math.random() * 2 ** 31)); }

            return (
                <div className="p-4 sm:p-6">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6 print:hidden">
                            <div>
                                <h1 className="text-3xl font-bold">Hallowed Hand - Bingo</h1>
                                <p className="text-sm text-slate-600 dark:text-slate-400">
                                    Click squares to mark them. Hit Randomize to get your unique board.
                                </p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={randomize} className="px-4 py-2 rounded-2xl bg-slate-900 text-white shadow">Randomize</button>
                                <button onClick={() => setDark(d => !d)} className="px-4 py-2 rounded-2xl bg-white dark:bg-slate-800 border shadow">
                                    {dark ? "Light Mode" : "Dark Mode"}
                                </button>
                            </div>
                        </div>

                        {boards.map(({ cells, idx }) => (
                            <div key={idx} className="bg-white dark:bg-slate-800 rounded-2xl shadow p-4 print:avoid-break max-w-2xl w-[min(92vw,42rem)] mx-auto">
                                <div className="flex items-baseline justify-between mb-3">
                                    <h2 className="text-xl font-semibold">Your Board</h2>
                                    <span className="text-xs text-slate-500 dark:text-slate-400">seed:{seed}</span>
                                </div>
                                <BingoGrid cells={cells} boardKey={`hhbingo-${seed}-${idx}`} />
                                <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">Center is FREE. Progress saves in your browser.</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>