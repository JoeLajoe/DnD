import React, { useMemo, useState, useEffect } from "react";

// --- Spoiler‑safe entries (25th is FREE space injected at center) ---
const ENTRIES = [
"Drops to 0 HP",
"This might be a trap",
"Nat 20 save",
"Checks coin / magic item",
"Melee complains about ranged",
"Potion used in combat",
"Argues about routes",
"Crit hit changes fight",
"Complains about cold",
"DM describes snow",
"Echo used cleverly",
"Echo takes a hit",
"Mispronounces NPC name",
"Eats rations",
"Forgets Inspiration",
"Don’t like this guy…",
"Sorcerer burns a big slot",
"Fighter shouts ‘I charge!’",
"Stealth plan fails",
"Ranger checks tracks",
"Nat 1 fail",
"Finds something unexpected",
"Party experiments with altar / strange object",
"Discovers a mysterious clue",
"Tries to talk their way out of trouble",
"Tries to bribe their way out of trouble",
];

// --- Tiny seeded RNG so links can reproduce boards ---
function mulberry32(seed: number) {
let a = seed >>> 0;
return function () {
a |= 0; a = a + 0x6D2B79F5 | 0;
let t = Math.imul(a ^ a >>> 15, 1 | a);
t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
return ((t ^ t >>> 14) >>> 0) / 4294967296;
};
}

function shuffle<T>(arr: T[], rng: () => number) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
    }

    function buildBoard(rng: () => number) {
    // choose 24 unique entries (FREE goes in center)
    const pool = shuffle(ENTRIES, rng).slice(0, 24);
    const cells = [...pool.slice(0, 12), "FREE", ...pool.slice(12)];
    return cells;
    }

    function useQueryParams() {
    const [params, setParams] = useState(() => new URLSearchParams(location.search));
    useEffect(() => {
    const sp = new URLSearchParams(location.search); setParams(sp);
    }, [location.search]);
    return params;
    }

    function downloadJSON(filename: string, data: any) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    export default function App() {
    const params = useQueryParams();
    const initialSeed = Number(params.get("seed") ?? Date.now());
    const initialCount = Number(params.get("count") ?? 5);

    const [seed, setSeed] = useState<number>(initialSeed);
        const [count, setCount] = useState<number>(isNaN(initialCount) ? 5 : Math.min(Math.max(initialCount, 1), 40));

            // Recompute boards when seed or count changes
            const boards = useMemo(() => {
            const rng = mulberry32(seed);
            return Array.from({ length: count }, (_, i) => buildBoard(rng));
            }, [seed, count]);

            const permalink = useMemo(() => {
            const url = new URL(location.href);
            url.searchParams.set("seed", String(seed));
            url.searchParams.set("count", String(count));
            return url.toString();
            }, [seed, count]);

            function randomize() {
            setSeed(Math.floor(Math.random() * 2 ** 31));
            }

            function printCards() {
            window.print();
            }

            function exportJSON() {
            downloadJSON(`hallowed-hand-bingo-${seed}.json`, { seed, count, boards, entries: ENTRIES });
            }

            return (
            <div className="min-h-screen bg-slate-50 text-slate-900 p-6">
                {/* Header / Controls */}
                <div className="max-w-6xl mx-auto">
                    <div
                        className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6 print:hidden">
                        <div>
                            <h1 className="text-3xl font-bold">Hallowed Hand – Player Bingo</h1>
                            <p className="text-sm text-slate-600">Spoiler‑safe, auto‑randomized boards. Share the
                                permalink for identical layouts.</p>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            <input type="number" min={1} max={40} value={count} onChange={(e)=> setCount(Math.min(40,
                            Math.max(1, Number(e.target.value) || 1)))}
                            className="px-3 py-2 rounded-2xl border border-slate-300"
                            aria-label="Number of boards"
                            title="Number of boards"
                            />
                            <input type="number" value={seed} onChange={(e)=> setSeed(Number(e.target.value) || 0)}
                            className="px-3 py-2 rounded-2xl border border-slate-300 w-40"
                            aria-label="Seed"
                            title="Seed"
                            />
                            <button onClick={randomize}
                                className="px-4 py-2 rounded-2xl bg-slate-900 text-white shadow">Randomize</button>
                            <button onClick={printCards}
                                className="px-4 py-2 rounded-2xl bg-white border shadow">Print</button>
                            <button onClick={exportJSON} className="px-4 py-2 rounded-2xl bg-white border shadow">Export
                                JSON</button>
                            <button onClick={()=> navigator.clipboard.writeText(permalink)}
                                className="px-4 py-2 rounded-2xl bg-white border shadow"
                                >Copy Link</button>
                        </div>
                    </div>

                    {/* Boards */}
                    <div className="grid md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {boards.map((cells, idx) => (
                        <div key={idx} className="bg-white rounded-2xl shadow p-4 print:break-inside-avoid">
                            <div className="flex items-baseline justify-between mb-3">
                                <h2 className="text-xl font-semibold">Board #{idx + 1}</h2>
                                <span className="text-xs text-slate-500">seed:{seed} • idx:{idx}</span>
                            </div>
                            <BingoGrid cells={cells} />
                            <p className="text-xs text-slate-500 mt-2">Mark off squares as they happen. Center is FREE.
                            </p>
                        </div>
                        ))}
                    </div>

                    {/* Footer note */}
                    <div className="mt-6 text-center print:hidden">
                        <p className="text-sm text-slate-500">Use the seed & count to reproduce boards. Entries are
                            spoiler‑safe.</p>
                    </div>
                </div>

                {/* Print styles */}
                <style>
                    {
                        ` @media print {
                            .print\\:hidden {
                                display: none !important;
                            }

                            .print\\:break-inside-avoid {
                                break-inside: avoid;
                            }

                            body {
                                background: white;
                            }
                        }

                        `
                    }
                </style>
            </div>
            );
            }

            function BingoGrid({ cells }: { cells: string[] }) {
            return (
            <div className="grid grid-cols-5 gap-2">
                {[...Array(25)].map((_, i) => (
                <div key={i}
                    className={ "rounded-2xl border border-slate-200 p-3 h-24 flex items-center justify-center text-center text-sm "
                    + (i===12 ? "bg-slate-100 font-semibold" : "bg-white" ) }>
                    <span>{cells[i]}</span>
                </div>
                ))}
            </div>
            );
            }